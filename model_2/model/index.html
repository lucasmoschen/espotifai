


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="https://lucasresck.github.io/espotifai/model_2/model/">
      
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.11">
    
    
      
        <title>Model based on playlist similarity - Espotifai</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.860688db.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.943997b5.min.css">
      
      
        
        
        <meta name="theme-color" content="#000000">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#model-based-on-playlist-similarity" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://lucasresck.github.io/espotifai/" title="Espotifai" class="md-header-nav__button md-logo" aria-label="Espotifai">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Espotifai
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Model based on playlist similarity
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/lucasresck/espotifai/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://lucasresck.github.io/espotifai/" title="Espotifai" class="md-nav__button md-logo" aria-label="Espotifai">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Espotifai
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/lucasresck/espotifai/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../related_work/" title="Related work" class="md-nav__link">
      Related work
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../evolution/" title="Project evolution" class="md-nav__link">
      Project evolution
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../eda/" title="EDA" class="md-nav__link">
      EDA
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../model_1/" title="Model based on track similarity" class="md-nav__link">
      Model based on track similarity
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Model based on playlist similarity
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="Model based on playlist similarity" class="md-nav__link md-nav__link--active">
      Model based on playlist similarity
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#treatment-of-data" class="md-nav__link">
    Treatment of data
  </a>
  
    <nav class="md-nav" aria-label="Treatment of data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tracks" class="md-nav__link">
    Tracks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training-validation-and-test-data" class="md-nav__link">
    Training, validation and test data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-model" class="md-nav__link">
    The model
  </a>
  
    <nav class="md-nav" aria-label="The model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#relevance-matrix-r" class="md-nav__link">
    Relevance matrix R
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#similarity" class="md-nav__link">
    Similarity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#track-score" class="md-nav__link">
    Track score
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluation" class="md-nav__link">
    Evaluation
  </a>
  
    <nav class="md-nav" aria-label="Evaluation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#r-precision-metric" class="md-nav__link">
    R-precision metric
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hyperparameter-k" class="md-nav__link">
    Hyperparameter k
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../conclusion/" title="Conclusion" class="md-nav__link">
      Conclusion
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#treatment-of-data" class="md-nav__link">
    Treatment of data
  </a>
  
    <nav class="md-nav" aria-label="Treatment of data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tracks" class="md-nav__link">
    Tracks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#training-validation-and-test-data" class="md-nav__link">
    Training, validation and test data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-model" class="md-nav__link">
    The model
  </a>
  
    <nav class="md-nav" aria-label="The model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#relevance-matrix-r" class="md-nav__link">
    Relevance matrix R
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#similarity" class="md-nav__link">
    Similarity
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#track-score" class="md-nav__link">
    Track score
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluation" class="md-nav__link">
    Evaluation
  </a>
  
    <nav class="md-nav" aria-label="Evaluation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#r-precision-metric" class="md-nav__link">
    R-precision metric
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hyperparameter-k" class="md-nav__link">
    Hyperparameter k
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/lucasresck/espotifai/edit/master/docs/model_2/model.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="model-based-on-playlist-similarity">Model based on playlist similarity</h1>
<p>Given a playlist, we want to add more tracks to it: it's the <strong>playlist continuation</strong> problem. Following <a href="https://dl.acm.org/doi/abs/10.1145/3267471.3267477">Kelen et al.</a>, the idea here is to define a similarity metric between two playlists, select the <script type="math/tex">k</script> most similar playlists to ours, define a score metric for tracks continuing our playlist and choose the best tracks to continue it.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">lil_matrix</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">spotipy.oauth2</span> <span class="kn">import</span> <span class="n">SpotifyClientCredentials</span>
<span class="kn">import</span> <span class="nn">spotipy</span>

<span class="n">auth_manager</span> <span class="o">=</span> <span class="n">SpotifyClientCredentials</span><span class="p">()</span>
<span class="n">sp</span> <span class="o">=</span> <span class="n">spotipy</span><span class="o">.</span><span class="n">Spotify</span><span class="p">(</span><span class="n">auth_manager</span><span class="o">=</span><span class="n">auth_manager</span><span class="p">)</span>
</code></pre></div>

<h2 id="treatment-of-data">Treatment of data</h2>
<h3 id="tracks">Tracks</h3>
<p>Here we load and treat the tracks dataset.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">tracks_dfs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Generator to concatenate the various files.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;../../data/sp_tracks_ready_*.pkl&#39;</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">file</span><span class="p">)[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;playlist_id&#39;</span><span class="p">,</span> <span class="s1">&#39;artists_ids&#39;</span><span class="p">]]</span>
        <span class="k">yield</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">file</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)})],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">tracks_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">tracks_dfs</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="mi">128</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tracks_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># The following is necessary to discard repeated playlists</span>
<span class="n">tracks_df</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracks_df</span><span class="o">.</span><span class="n">index</span>
<span class="n">grouped</span> <span class="o">=</span> <span class="n">tracks_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;playlist_id&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">]</span>
<span class="p">)[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">tracks_df</span> <span class="o">=</span> <span class="n">tracks_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="nb">list</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">[</span><span class="n">grouped</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span>
        <span class="s1">&#39;playlist_id&#39;</span>
    <span class="p">)]</span><span class="o">.</span><span class="n">idx</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">]</span>
<span class="p">)</span>
<span class="k">del</span> <span class="n">grouped</span>
<span class="n">tracks_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;idx&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>We treat the playlists dataset:</p>
<div class="highlight"><pre><span></span><code><span class="n">playlists</span> <span class="o">=</span> <span class="n">tracks_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;playlist_id&#39;</span><span class="p">)[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</code></pre></div>

<p>We treat the artists for each track:</p>
<div class="highlight"><pre><span></span><code><span class="n">artists</span> <span class="o">=</span> <span class="n">tracks_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">artists_ids</span>
<span class="n">artists</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;track_id&#39;</span>
<span class="n">artists_ids</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">artists</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">artists</span><span class="p">))))</span>
</code></pre></div>

<h2 id="training-validation-and-test-data">Training, validation and test data</h2>
<p>Now we split the data:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">split_data</span><span class="p">(</span><span class="n">playlists</span><span class="p">,</span> <span class="n">test_frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>

    <span class="c1"># Only playlists between 5 and 250 tracks</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">playlists</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">playlists</span> <span class="o">=</span> <span class="n">playlists</span><span class="p">[(</span><span class="n">query</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">query</span> <span class="o">&lt;=</span> <span class="mi">250</span><span class="p">)]</span>

    <span class="c1"># Split training and test data</span>
    <span class="n">n_test</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">playlists</span><span class="p">)</span><span class="o">*</span><span class="n">test_frac</span><span class="p">))</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">playlists</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">playlists_test</span> <span class="o">=</span> <span class="n">playlists</span><span class="p">[(</span><span class="n">query</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">)]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n_test</span><span class="p">)</span>
    <span class="n">playlists_training</span> <span class="o">=</span> <span class="n">playlists</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">playlists_test</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">playlists_training</span><span class="p">,</span> <span class="n">playlists_test</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">playlists_training</span><span class="p">,</span> <span class="n">playlists_test</span> <span class="o">=</span> <span class="n">split_data</span><span class="p">(</span><span class="n">playlists</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">playlists_training</span><span class="p">,</span> <span class="n">playlists_validation</span> <span class="o">=</span> <span class="n">split_data</span><span class="p">(</span><span class="n">playlists_training</span><span class="p">)</span>
</code></pre></div>

<h2 id="the-model">The model</h2>
<h3 id="relevance-matrix-r">Relevance matrix <script type="math/tex">R</script>
</h3>
<p>We build the relevance matrix <script type="math/tex">R</script>.</p>
<p>
<script type="math/tex">R_{ij}=r_{ij}</script> indicates if a track <script type="math/tex">j</script> is relevant to the playlist <script type="math/tex">i</script>, that is, the track is in the playlist.</p>
<p>Because we will use matrix multiplication, we have to index each track ID and each playlist ID to an index of the matrix. We do it here using dictionaries.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">matrix_r</span><span class="p">(</span><span class="n">playlists_training</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create relevance matrix R.&quot;&quot;&quot;</span>
    <span class="n">all_tracks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">playlist</span> <span class="ow">in</span> <span class="n">playlists_training</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
        <span class="n">all_tracks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">playlist</span><span class="p">)</span>
    <span class="n">all_tracks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_tracks</span><span class="p">))</span>

    <span class="n">track_ids_go</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_tracks</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_tracks</span><span class="p">))))</span>
    <span class="n">track_ids_back</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">track_ids_go</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">track_ids_go</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">playlist_ids</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span><span class="n">playlists_training</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">playlists_training</span><span class="o">.</span><span class="n">index</span><span class="p">)))</span>
    <span class="p">))</span>

    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">playlists_training</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_tracks</span><span class="p">))</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">lil_matrix</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">playlist_id</span><span class="p">,</span> <span class="n">playlist</span> <span class="ow">in</span> <span class="n">playlists_training</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">track_id</span> <span class="ow">in</span> <span class="n">playlist</span><span class="p">:</span>
            <span class="n">R</span><span class="p">[</span><span class="n">playlist_ids</span><span class="p">[</span><span class="n">playlist_id</span><span class="p">],</span> <span class="n">track_ids_go</span><span class="p">[</span><span class="n">track_id</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">track_ids_go</span><span class="p">,</span> <span class="n">track_ids_back</span><span class="p">,</span> <span class="n">playlist_ids</span><span class="p">,</span> <span class="n">R</span>
</code></pre></div>

<h3 id="similarity">Similarity</h3>
<p>The similarity between two playlists <script type="math/tex">u</script> and <script type="math/tex">v</script> is calculated by:
<script type="math/tex; mode=display">s_{uv} = \sum_{i \in I} \dfrac{r_{ui}r_{vi}}{||R_u||_2||R_v||_2}</script>
<script type="math/tex">I</script> is the set of tracks and <script type="math/tex">R_u</script> is the vector of relevances <script type="math/tex">r_{ui}</script> for the playlist <script type="math/tex">u</script>.</p>
<p>In fact, we basically count the number of tracks in the intersection of the playlists and normalize it.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">similarity</span><span class="p">(</span><span class="n">playlist_1</span><span class="p">,</span> <span class="n">playlist_2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the similarity between two playlists.&quot;&quot;&quot;</span>
    <span class="n">summation</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">playlist_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">playlist_2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">summation</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">summation</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">playlist_1</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">playlist_2</span><span class="p">))</span>
</code></pre></div>

<h3 id="track-score">Track score</h3>
<p>Given a playlist <script type="math/tex">u</script> to be continuated, we calculate the similarity of it with all existent playlists and select the <script type="math/tex">k</script> most similar playlists, that is, the set <script type="math/tex">N_k(u)</script>. So, we define a score for a track to be in the playlist:
<script type="math/tex; mode=display">\hat{r}_{ui} = \dfrac{\sum_{v \in N_k(u)} s_{uv} \cdot r_{vi}}{\sum_{v \in N_k(u)} s_{uv}}</script>
</p>
<p>The intuition is that we are giving high scores to tracks that are in many playlists with great similarities to our playlist. We return the tracks ordered by score.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">continuation</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">playlist</span><span class="p">,</span> <span class="n">playlists_training</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">playlist_ids</span><span class="p">,</span> <span class="n">track_ids_back</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Continue a playlist based on k most similar playlists.&quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">playlists_training</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
    <span class="n">s_u</span> <span class="o">=</span> <span class="n">lil_matrix</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">alt_playlist_index</span><span class="p">,</span> <span class="n">alt_playlist</span> <span class="ow">in</span> <span class="n">playlists_training</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">similarity</span><span class="p">(</span><span class="n">playlist</span><span class="p">,</span> <span class="n">alt_playlist</span><span class="p">)</span>
        <span class="n">s_u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">playlist_ids</span><span class="p">[</span><span class="n">alt_playlist_index</span><span class="p">]]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="n">sorted_similarities_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">s_u</span><span class="o">.</span><span class="n">toarray</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">top_k_similarities_indices</span> <span class="o">=</span> <span class="n">sorted_similarities_indices</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">s_u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_k_similarities_indices</span><span class="p">]</span><span class="o">*</span><span class="n">R</span><span class="p">[</span><span class="n">top_k_similarities_indices</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">toarray</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sorted_scores_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">)[</span><span class="o">-</span><span class="mi">225</span><span class="p">:])</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">track_ids_back</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">sorted_scores_indices</span><span class="p">]</span>
</code></pre></div>

<h3 id="summary">Summary</h3>
<ul>
<li>We choose a playlist to be continuated;</li>
<li>We calculate the similarity between this and each playlist in the training dataset;</li>
<li>We calculate the score of each track continuating our playlist;</li>
<li>We choose the tracks with highest score.</li>
</ul>
<h2 id="evaluation">Evaluation</h2>
<h3 id="r-precision-metric">R-precision metric</h3>
<p>As described in their work, <a href="https://dl.acm.org/doi/10.1145/3240323.3240342">Chen et al.</a> suggest a metric for playlist continuation playlist evaluation. They call it <strong>R-precision</strong>. It measures how many of the real tracks (and their artists) the model correctly suggested.</p>
<p>A playlist as input to the model has two parts: the part the model will see and the part the model will try to predict, called <em>ground truth</em>.</p>
<p>
<script type="math/tex; mode=display">\textrm{R-precision} = \dfrac{|S_T \cap G_T| + 0.25 \cdot |S_A \cap G_A|}{|G_T|}</script>
</p>
<p>
<script type="math/tex">G_T</script> is the set of unique track IDs from ground truth, that is, the unique hidden tracks. <script type="math/tex">S_T</script> is the suggested tracks from our model. <script type="math/tex">G_A</script> is the set of unique artists IDs from ground truth and <script type="math/tex">S_A</script> is the set of predicted artists. The metric can be interpreted as accuracy (although it can be greater than 1), but giving some score for wrong tracks with right artists.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">r_precision</span><span class="p">(</span><span class="n">S_t</span><span class="p">,</span> <span class="n">G_t</span><span class="p">,</span> <span class="n">S_a</span><span class="p">,</span> <span class="n">G_a</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">S_t</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">G_t</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">S_a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">G_a</span><span class="p">)))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">G_t</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">evaluation</span><span class="p">(</span><span class="n">playlist_not_hidden</span><span class="p">,</span> <span class="n">playlist_hidden</span><span class="p">,</span> <span class="n">continuation</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">playlist_not_hidden</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">continuation</span><span class="p">:</span>
            <span class="n">continuation</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">track</span><span class="p">)</span>
    <span class="n">continuation</span> <span class="o">=</span> <span class="n">continuation</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">playlist_hidden</span><span class="p">)]</span>

    <span class="n">G_a</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">playlist_hidden</span><span class="p">:</span>
        <span class="n">G_a</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">artists</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">artists_ids</span><span class="p">[</span><span class="n">track</span><span class="p">]])</span>
    <span class="n">S_a</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">continuation</span><span class="p">:</span>
        <span class="n">S_a</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">artists</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">artists_ids</span><span class="p">[</span><span class="n">track</span><span class="p">]])</span>

    <span class="n">metric</span> <span class="o">=</span> <span class="n">r_precision</span><span class="p">(</span><span class="n">continuation</span><span class="p">,</span> <span class="n">playlist_hidden</span><span class="p">,</span> <span class="n">S_a</span><span class="p">,</span> <span class="n">G_a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span>
</code></pre></div>

<h3 id="hyperparameter-k">Hyperparameter <script type="math/tex">k</script>
</h3>
<p>We now select a <script type="math/tex">k</script> value that maximizes the R-precision metric in a sample in our validation dataset. It's not feasible to select <script type="math/tex">k</script> by cross-validation, because we need test data to have more than 25 tracks.</p>
<div class="highlight"><pre><span></span><code><span class="n">track_ids_go</span><span class="p">,</span> <span class="n">track_ids_back</span><span class="p">,</span> <span class="n">playlist_ids</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">matrix_r</span><span class="p">(</span><span class="n">playlists_training</span><span class="p">)</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">playlists_training</span><span class="p">)]):</span>
    <span class="n">metric_summation</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">playlist</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">playlists_validation</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">)):</span>
        <span class="n">playlist_not_hidden</span> <span class="o">=</span> <span class="n">playlist</span><span class="p">[:</span><span class="mi">25</span><span class="p">]</span>
        <span class="n">playlist_hidden</span> <span class="o">=</span> <span class="n">playlist</span><span class="p">[</span><span class="mi">25</span><span class="p">:]</span>
        <span class="n">continuated</span> <span class="o">=</span> <span class="n">continuation</span><span class="p">(</span>
            <span class="n">R</span><span class="p">,</span> <span class="n">playlist_not_hidden</span><span class="p">,</span> <span class="n">playlists_training</span><span class="p">,</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">playlist_ids</span><span class="p">,</span> <span class="n">track_ids_back</span>
        <span class="p">)</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">evaluation</span><span class="p">(</span><span class="n">playlist_not_hidden</span><span class="p">,</span> <span class="n">playlist_hidden</span><span class="p">,</span> <span class="n">continuated</span><span class="p">)</span>
        <span class="n">metric_summation</span> <span class="o">+=</span> <span class="n">metric</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_summation</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">playlists_training</span><span class="p">)],</span>
    <span class="n">y</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;R-precision vs. k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;R-precision&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<p><img alt="png" src="../output_40_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">playlists_training</span><span class="p">)][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">metrics</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The best k is </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>The best k is 100.
</code></pre></div>

<p>Now we train and evaluate our model:</p>
<div class="highlight"><pre><span></span><code><span class="n">playlists_all_training</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">playlists_training</span><span class="p">,</span> <span class="n">playlists_validation</span><span class="p">])</span>
<span class="n">track_ids_go</span><span class="p">,</span> <span class="n">track_ids_back</span><span class="p">,</span> <span class="n">playlist_ids</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">matrix_r</span><span class="p">(</span><span class="n">playlists_all_training</span><span class="p">)</span>
<span class="n">metric_summation</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">playlist</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">playlists_test</span><span class="p">):</span>
    <span class="n">playlist_not_hidden</span> <span class="o">=</span> <span class="n">playlist</span><span class="p">[:</span><span class="mi">25</span><span class="p">]</span>
    <span class="n">playlist_hidden</span> <span class="o">=</span> <span class="n">playlist</span><span class="p">[</span><span class="mi">25</span><span class="p">:]</span>
    <span class="n">continuated</span> <span class="o">=</span> <span class="n">continuation</span><span class="p">(</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">playlist_not_hidden</span><span class="p">,</span> <span class="n">playlists_all_training</span><span class="p">,</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">playlist_ids</span><span class="p">,</span> <span class="n">track_ids_back</span>
    <span class="p">)</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">evaluation</span><span class="p">(</span><span class="n">playlist_not_hidden</span><span class="p">,</span> <span class="n">playlist_hidden</span><span class="p">,</span> <span class="n">continuated</span><span class="p">)</span>
    <span class="n">metric_summation</span> <span class="o">+=</span> <span class="n">metric</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;R-precision = </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric_summation</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">playlists_test</span><span class="p">)))</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>R-precision = 0.1107
</code></pre></div>

<p>As said by <a href="https://dl.acm.org/doi/10.1145/3240323.3240342">Chen et al.</a>, the highest performance achieved in <em>RecSys Challenge 2018</em> was 0.2241. Well, many competitors were using much more advanced models, like neural networks, and they also had much more data and possible more computational power. So the results we achieved seems much reasonable.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../../model_1/" title="Model based on track similarity" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Model based on track similarity
              </div>
            </div>
          </a>
        
        
          <a href="../../conclusion/" title="Conclusion" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Conclusion
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.df0def68.min.js"></script>
      <script src="../../assets/javascripts/bundle.ba57d267.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>